# BOT SYSTEM


# Технические данные

| Окружение      | Версия |
| --------- | -----|
| PHP  | 8.1 |
| Сервер     |  Apache/2.4.54 (Debian) |
| База данных      |    Mariadb 10.5 |
| Yii Version      |   2.0.48-dev |
| Yii Template      |   Basic |

## Копирование настроек окружения

Копируем файл настройки проекта:

`$ cp .env.dist .env`

Указываем локальные параметры 

DB_USERNAME - база пользователь (по умолчанию root)
DB_PASSWORD - база пароль (по умолчанию root)
TELEGRAM_MAIN - Токен телеграмм бота откуда парсятся сообщения

Копируем файл настройки Docker:

`$ cp docker-compose.yml.dist docker-compose.yml`

## Настройка окружения

После копирования файлов необходимо настроить файлы **.env** и **docker-compose.yml** под свое окружение. Настройки рабочего сервера см выше. Все инструкции ниже будут подразумевать дефолтные настройки.

Важно:
- В папке **src/mysql/mysql-dump** должен находиться только один файл с расширением **.sql** для каждой базы. Например, если вы используете тестовую БД и рабочую, в папке могут находиться два файла, которые предполагают выгрузку двух разных БД.
- Папка **src/mysql/db** должна быть пустой или вообще отсутствовать, т.к. именно туда будет автоматически установлена база данных после запуска контейнеров. Если при запуске контейнеров папка **db** не пустая, дампы БД залиты не будут.
- Если не используете докер, дамп БД берите с папки **src/mysql/mysql-dump**.

Запускаем контейнеры Docker:

`$ docker-compose up -d`

Устанавливаем пакеты зависимостей:

`$ composer install`

Иногда после команды composer install выпадают множественные ошибки, например, из-за отсутствия необходимых библиотек PHP. В этом случае либо устраняем все ошибки, либо устанавливаем пакеты проекта без учета зависимостей:

`$ composer install --ignore-platform-reqs`

Не забываем держать в уме, что игнорирование зависимостей может в будущем приводить к ошибкам на страницах проекта.

+ Сайт доступен по адресу: http://localhost:8000
+ phpMyAdmin доступен по адресу: http://localhost:8080
    * **Логин:** root
    * **Пароль:** root

Для чтения новых сообщений
- **Установить cron на адресс */5 * * * * wget -O /dev/null -nv http://YOURDOMAIN:8080/parsing или любым удобным методом**

Для отправки шаблонов
- **Установить cron на адресс */7 * * * * wget -O /dev/null -t 1 -q 'http://sodrujjo.beget.tech/panel/sender/send' или любым удобным методом**




### Требования по работе с кодом
- **Если по ходу выполнения задания нужно установить какие-то новые пакеты зависимостей, !ОБЯЗАТЕЛЬНО! делаем это через composer, а не вручную:**

`$ composer require <название пакета>`

- Все изменения в БД делаем с помощью миграций. Для этого заходим в контейнер:

`$ docker exec -ti <ID_или_наименование_контейнера_php> bash`

И создаем миграции

`$ php yii migrate/create <название миграции>`


#### Принцип работы

Парсер заправшивает кроном с указаного бот в TELEGRAM_MAIN последние сообщения, после по логике указаные в ситеме, в вкладке "шаблоны" делает рассылку по ботам указаным в разделе "боты"

##### Возможные проблемы

Иногда проект не запускается без файла **.htaccess**. В папке **src** есть два файла **.htaccess** с разными данными, скопируйте нужный из них в корень проекта командой:

`$ cp src/.htaccess1 .htaccess`

или

`$ cp src/.htaccess2 .htaccess`

Так же может понадобится создать папку runtime в корне

`$ mkdir runtime`

и дать ей права 777

`$ chmod 777 runtime`

Так же может понадобится дать права на папку web/assets 777

`$ chmod 777 web/assets`